<div class="card mb-4">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold">Inventario de Productos</h2>
  </div>

  <p-table #dt [value]="productList" dataKey="id" [rows]="5" [rowsPerPageOptions]="[5,10,25]" [paginator]="true"
           [loading]="loading" [globalFilterFields]="['name','category.name','inventoryState']"
           size="small" [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos">

    <ng-template #caption>
      <div class="flex justify-end mb-2">
        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value,'contains')" placeholder="Buscar..." />
        <button pButton label="Nuevo Producto" icon="pi pi-plus" class="p-button-sm" (click)="openNew()"></button>
      </div>

    </ng-template>

    <ng-template #header>
      <tr>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Estado</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template #body let-product>
      <tr class="text-sm">
        <td class="text-center">
          <img [src]="getImageUrl(product.image)" [alt]="product.name" class="w-20 h-20 object-cover rounded-md mx-auto" />
        </td>
        <td class="font-medium truncate max-w-xs">{{ product.name }}</td>
        <td class="truncate max-w-xs">{{ product.category.name }}</td>
        <td><p-tag [value]="product.inventoryState" [severity]="getSeverity(product.inventoryState)" class="text-xs py-1 px-2"></p-tag></td>
        <td>{{ product.price | currency:'Bs. ' }}</td>
        <td>{{ product.stock }}</td>
        <td class="flex gap-1 flex-wrap justify-center">
          <button   severity="info" [rounded]="true" pButton icon="pi pi-upload" class="p-button-sm" (click)="fileInput.click()" title="Subir foto"></button>
          <input type="file" #fileInput accept="image/*" style="display:none" (change)="onFileSelected($event, product)" />

          <button severity="success"  [rounded]="true" pButton icon="pi pi-pencil" class="p-button-sm" (click)="editProduct(product)" title="Editar"></button>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr><td colspan="7" class="text-center text-sm">No se encontraron productos.</td></tr>
    </ng-template>

  </p-table>
</div>

<!-- Dialog para Crear / Editar -->
 <p-dialog
  [(visible)]="productDialog"
  [style]="{ width: '450px' }"
  header="{{ isEditMode ? 'Editar Producto' : 'Nuevo Producto' }}"
  [modal]="true">

  <ng-template #content>
    <form [formGroup]="productForm" class="flex flex-col gap-6">

      <!-- Nombre -->
      <div>
        <label class="block font-bold mb-3">Nombre</label>
        <input pInputText formControlName="name" fluid />
        <small class="text-red-500"
          *ngIf="submitted && productForm.get('name')?.invalid">
          El nombre es requerido
        </small>
      </div>

      <!-- Categoría -->
      <div>
        <label class="block font-bold mb-3">Categoría</label>
        <p-select
          [options]="categories"
          optionLabel="name"
          optionValue="id"
          placeholder="Seleccione categoría"
          formControlName="categoryId"
          fluid>
        </p-select>
      </div>

      <!-- Precio + Stock -->
      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-6">
          <label class="block font-bold mb-3">Precio</label>
          <p-inputnumber
            formControlName="price"
            mode="decimal"
            fluid>
          </p-inputnumber>
        </div>

        <div class="col-span-6">
          <label class="block font-bold mb-3">Stock</label>
          <p-inputnumber
            formControlName="stock"
            fluid>
          </p-inputnumber>
        </div>
      </div>

      <!-- Estado -->
      <div>
        <label class="block font-bold mb-3">Estado</label>
        <p-select
          [options]="inventoryStates"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione estado"
          formControlName="inventoryState"
          fluid>
        </p-select>
      </div>

      <!-- Imagen -->
      <div>
        <label class="block font-bold mb-3">Imagen</label>
        <input
          type="file"
          class="p-inputtext w-full"
          (change)="onFileSelected($event, selectedProduct)" />
      </div>

    </form>
  </ng-template>

  <ng-template #footer>
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      text
      (click)="hideDialog()" />

    <p-button
      label="{{ isEditMode ? 'Actualizar' : 'Crear' }}"
      icon="pi pi-check"
      (click)="saveProduct()" />
  </ng-template>

</p-dialog>


