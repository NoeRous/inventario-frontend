<div class="card mb-4">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold">Inventario de Productos</h2>
  </div>

  <p-table #dt [value]="productList" stripedRows dataKey="id" [rows]="5" [rowsPerPageOptions]="[5,10,25]"
    [paginator]="true" [loading]="loading" [globalFilterFields]="['name','category.name','inventoryState']" size="small"
    [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos">

    <ng-template #caption>
      <div class="flex justify-end mb-2">
        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value,'contains')"
          placeholder="Buscar..." />
        <button pButton label="Nuevo Producto" icon="pi pi-plus" class="p-button-sm" (click)="openNew()"></button>
      </div>

    </ng-template>

    <ng-template #header>
      <tr>
        <th>Imagen</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Estado</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template #body let-product>
      <tr class="text-sm">
        <td class="text-center">
          <img [src]="getImageUrl(product.image)" [alt]="product.name"
            class="w-20 h-20 object-cover rounded-md mx-auto" />
        </td>
        <td class="font-medium truncate max-w-xs">
          {{ product.name }}
          <br>
          <small> {{ product.description }}</small>
        </td>
        <td class="truncate max-w-xs">{{ product.category.name }}</td>
        <td><p-tag [value]="product.inventoryState" [severity]="getSeverity(product.inventoryState)"
            class="text-xs py-1 px-2"></p-tag></td>
        <td>{{ product.price | currency:'Bs. ' }}</td>
        <td>{{ product.stock }}</td>
        <td class="flex gap-1 flex-wrap justify-center">
          <button severity="info" [rounded]="true" pButton icon="pi pi-upload" class="p-button-sm"
            (click)="fileInput.click()" title="Subir foto"></button>
          <input type="file" #fileInput accept="image/*" style="display:none"
            (change)="onFileSelected($event, product)" />

          <button severity="success" [rounded]="true" pButton icon="pi pi-pencil" class="p-button-sm"
            (click)="editProduct(product)" title="Editar"></button>
          <p-button (onClick)="displayProductDetails(product)" icon="pi pi-search" severity="secondary" rounded />

          <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
            (click)="confirmDeleteProduct($event, product)"  />
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <tr>
        <td colspan="7" class="text-center text-sm">No se encontraron productos.</td>
      </tr>
    </ng-template>

  </p-table>
</div>

<!-- Dialog para Crear / Editar -->
<p-dialog [(visible)]="productDialog" [style]="{ width: '450px' }"
  header="{{ isEditMode ? 'Editar Producto' : 'Nuevo Producto' }}" [modal]="true">

  <ng-template #content>
    <form [formGroup]="productForm" class="flex flex-col gap-6">

      <!-- cod -->
      <div>
        <label class="block font-bold mb-3">Código</label>
        <input pInputText formControlName="code" fluid />
        <small class="text-red-500" *ngIf="submitted && productForm.get('code')?.invalid">
          El código es requerido
        </small>
      </div> 

      <!-- Nombre -->
      <div>
        <label class="block font-bold mb-3">Nombre</label>
        <input pInputText formControlName="name" fluid />
        <small class="text-red-500" *ngIf="submitted && productForm.get('name')?.invalid">
          El nombre es requerido
        </small>
      </div>

      <!-- Descripción -->
      <div>
        <label class="block font-bold mb-3">Descripción</label>
        <input pInputText formControlName="description" fluid />
        <small class="text-red-500" *ngIf="submitted && productForm.get('description')?.invalid">
          La descripción es requerida
        </small>
      </div>

      <!-- Categoría -->
      <div>
        <label class="block font-bold mb-3">Categoría</label>
        <p-select [options]="categories" optionLabel="name" optionValue="id" placeholder="Seleccione categoría"
          formControlName="categoryId" fluid>
        </p-select>
      </div>

      <!-- Precio + Stock -->
      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-6">
          <label class="block font-bold mb-3">Precio</label>
          <p-inputnumber formControlName="price" mode="decimal" fluid>
          </p-inputnumber>
        </div>

        <div class="col-span-6">
          <label class="block font-bold mb-3">Stock</label>
          <p-inputnumber formControlName="stock" fluid>
          </p-inputnumber>
        </div>
      </div>

      <!-- Estado -->
      <div>
        <label class="block font-bold mb-3">Estado</label>
        <p-select [options]="inventoryStates" optionLabel="label" optionValue="value" placeholder="Seleccione estado"
          formControlName="inventoryState" fluid>
        </p-select>
      </div>

      <!-- Imagen -->
      <div>
        <label class="block font-bold mb-3">Imagen</label>
        <input type="file" class="p-inputtext w-full" (change)="onFileSelected($event, selectedProduct())" />
      </div>

    </form>
  </ng-template>

  <ng-template #footer>
    <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />

    <p-button label="{{ isEditMode ? 'Actualizar' : 'Crear' }}" icon="pi pi-check" (click)="saveProduct()" />
  </ng-template>

</p-dialog>
<p-dialog [(visible)]="detailsDialog" header="Detalles del Producto" [modal]="true" [style]="{ width: '80vw' }">

  <!-- FORMULARIO -->
  <div class="surface-50 p-4 mb-4 border-round shadow-1">
      <form [formGroup]="detailForm">
        <div class="grid grid-cols-12 gap-4 items-end">

          <div class="col-span-12 md:col-span-2">
            <label class="block text-sm text-600 mb-1">Color</label>
            <input pInputText formControlName="color" class="w-full"  placeholder="Ej: Rojo"/>
             <small class="text-red-500" *ngIf="submittedDetail && detailForm.get('color')?.invalid">
              El color es requerido
            </small>
          </div>

          <div class="col-span-12 md:col-span-2">
            <label class="block text-sm text-600 mb-1">Talla</label>
            <input pInputText formControlName="size" placeholder="Ej: M" class="w-full" />
            <small class="text-red-500" *ngIf="submittedDetail && detailForm.get('size')?.invalid">
              La talla es requerida
            </small>
          </div>

          <div class="col-span-12 md:col-span-2">
            <label class="block text-sm text-600 mb-1">Stock</label>
            <input pInputText type="number" formControlName="stock" class="w-full" />
            <small class="text-red-500" *ngIf="submittedDetail && detailForm.get('stock')?.invalid">
              El stock es requerido
            </small>
          </div>

          <div class="col-span-12 md:col-span-2">
            <label class="block text-sm text-600 mb-1">Almacén</label>
            <input pInputText formControlName="warehouse" placeholder="Principal"  class="w-full" />
              <small class="text-red-500" *ngIf="submittedDetail && detailForm.get('warehouse')?.invalid">
              El almacén es requerido
            </small>
          </div>

          <div class="col-span-12 md:col-span-4">
            <button pButton type="button" class="w-full" [severity]="isEditDetail ? 'info' : 'success'"
              [label]="isEditDetail ? 'Actualizar detalle' : 'Agregar detalle'"
              [icon]="isEditDetail ? 'pi pi-check' : 'pi pi-plus'" (click)="saveDetail()">
            </button>

            @if (isEditDetail) {
              <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="secondary"
                (click)="resetForm()" title="Cancelar edición" />
            }
          </div>
        </div>
      </form>
  </div>

  <!-- TABLA -->
  <p-table [value]="selectedProductDetails()" dataKey="id" selectionMode="single" [(selection)]="selectedDetail"
    (onRowSelect)="onSelectDetail($event)" showGridlines rowHover class="p-datatable-sm">

    <ng-template pTemplate="header">
      <tr>
        <th>Color</th>
        <th>Talla</th>
        <th>Stock</th>
        <th>Almacén</th>
        <th>Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-detail>
      <tr [pSelectableRow]="detail" class="cursor-pointer">
        <td>{{ detail.color }}</td>
        <td>
          <span class="font-semibold">{{ detail.size }}</span>
        </td>
        <td>
          <p-tag [value]="detail.stock" severity="info"></p-tag>
        </td>
        <td>{{ detail.warehouse }}</td>
        <td>
          <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
            (click)="confirmDeleteDetail($event, detail)"  />
        </td>
      </tr>
    </ng-template>

  </p-table>

</p-dialog>

<div class="card flex justify-center gap-2">
  <p-toast />
  <p-confirmdialog />
</div>